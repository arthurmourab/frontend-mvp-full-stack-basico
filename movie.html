<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Filme</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<main>
    <div id="movie-details"></div>

    <div id="watch-section">
        <button id="mark-watched">Marcar como assistido</button>
    </div>

    <div id="review-section">
        <h2>Avaliar filme</h2>
        <input type="text" id="review-title" placeholder="Título da avaliação">
        <textarea id="review-content" placeholder="Escreva seu comentário..."></textarea>
        <input type="number" id="review-rating" min="0" max="10" step="0.1" placeholder="Nota (0 a 10)">
        <button id="submit-review">Enviar Avaliação</button>
    </div>
</main>

<script>
    let userId = null;

    // Primeiro, pega o ID do usuário logado
    fetch("http://localhost:5000/auth/me", {
        credentials: "include"
    })
        .then(res => res.json())
        .then(user => {
            userId = user.id;

            // Depois, carrega detalhes do filme
            return fetch(`http://localhost:5000/movies/${movieId}`);
        })
        .then(res => res.json())
        .then(movie => {
            const details = document.getElementById("movie-details");
            details.innerHTML = `
      <h1>${movie.name}</h1>
      <img src="img/${movie.cover}" alt="${movie.name}" />
      <p><strong>Gênero:</strong> ${movie.genre}</p>
      <p><strong>Ano:</strong> ${movie.year}</p>
      <p><strong>Visualizações:</strong> ${movie.views}</p>
      <p><strong>Média de Avaliação:</strong> ${movie.average_rating ?? "Sem avaliações ainda"}</p>
    `;

            // Verifica se o usuário já assistiu ao filme
            return fetch(`http://localhost:5000/watched/check?user_id=${userId}&movie_id=${movieId}`, {
                credentials: "include"
            });
        })
        .then(res => res.json())
        .then(watchedData => {
            if (!watchedData.watched) {
                document.getElementById("review-section").style.display = "none";
            } else {
                // Agora verifica se o usuário já avaliou
                return fetch(`http://localhost:5000/reviews/check?user_id=${userId}&movie_id=${movieId}`, {
                    credentials: "include"
                }).then(res => res.json())
                    .then(reviewData => {
                        if (reviewData.exists) {
                            document.getElementById("review-section").style.display = "none";
                        }
                    });
            }
        });

</script>
</body>
</html>
